#!/bin/bash
# Disable Artifact Registry Vulnerability Scanning to minimize GCP costs
# This script is idempotent and safe to run multiple times
#
# Required environment variables:
#   AR_REPOSITORY - Name of the Artifact Registry repository
#   GCP_REGION    - GCP region (defaults to us-central1 if not set)
#
# Usage:
#   AR_REPOSITORY=gcp-todoist-runner GCP_REGION=us-central1 ./disable-ar-vulnerability-scanning.sh

set -euo pipefail

# Configuration with defaults
AR_REPOSITORY="${AR_REPOSITORY:-}"
GCP_REGION="${GCP_REGION:-us-central1}"

# Validation
if [ -z "$AR_REPOSITORY" ]; then
  echo "‚ùå ERROR: AR_REPOSITORY environment variable is required"
  echo "Usage: AR_REPOSITORY=repo-name GCP_REGION=us-central1 $0"
  exit 1
fi

echo "üîß Disabling Artifact Registry vulnerability scanning for cost optimization..."
echo "   Repository: $AR_REPOSITORY"
echo "   Region: $GCP_REGION"

# Attempt to disable vulnerability scanning (idempotent operation)
if gcloud artifacts repositories update "$AR_REPOSITORY" \
  --location="$GCP_REGION" \
  --disable-vulnerability-scanning 2>&1 | tee /tmp/ar-disable-output.log; then
  echo "‚úÖ Vulnerability scanning disabled successfully"
  exit 0
elif grep -q "already disabled" /tmp/ar-disable-output.log; then
  echo "‚úÖ Vulnerability scanning already disabled (no changes needed)"
  exit 0
else
  echo "‚ö†Ô∏è  Warning: Could not disable vulnerability scanning (may already be disabled or insufficient permissions)"
  echo "   This is not critical - continuing deployment..."
  exit 0
fi
